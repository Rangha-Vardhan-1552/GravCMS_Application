{% block footer %}
<style>
    /* CSS for chat container */
    #chat-container {
        max-height: 250px;
        overflow-y: auto;
        padding: 10px;
    }

    .card {
        border-radius: 10px;
        background: rgb(244, 248, 253);
    }

    #chat-form {
        justify-content: flex-end;
        column-gap: 10px;
    }

    .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 50%;
    }

    .user {
        background-color: #007bff;
        color: #fff;
        align-self: flex-end;
        margin-left: auto; /* Push user messages to the right */
    }

    .bot {
        background-color: white;
        color: #333;
        align-self: flex-start;
    }

    /* CSS for typing indicator */
    .typing-indicator {
        display: none;
        margin-bottom: 5px; /* Move typing indicator to the bottom */
        font-style: italic;
        align-self: flex-start; /* Align to the right */
    }

    .typing-indicator::after {
        content: 'Typing...';
        animation: typing 1s infinite;
    }

    @keyframes typing {
        0% {
            opacity: 0.5;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    /* CSS for input field */
    .form-control {
        border-radius: 10px;
        width: 70%;
    }

    /* CSS for send button */
    .btn-primary {
        border-radius: 10px;
    }

    #chatbot-trigger-btn:hover {
        cursor: pointer;
    }

    .chatbot-trigger {
        text-align: right;
    }

</style>

<div class="chatbot-trigger" style="position: fixed; bottom: 60px; right: 60px; justify-content: right;">
    <img src="https://img.freepik.com/premium-vector/robot-icon-chat-bot-sign-support-service-concept-chatbot-character-flat-style_41737-795.jpg" alt="Chatbot" id="chatbot-trigger-btn" style="width: 20%; height: 30%;">
</div>
<section id="footer" class="section bg-gray">
    <!-- Chatbot image trigger -->
    <!-- Chatbot container -->
    <div id="chatbot-popup" style="display: none; position: fixed; bottom: 250px; right: 5px; background-color: white; width: 30%;">
        <!-- Chatbot container content -->
        <div class="container">
            <div class="row">
                <div class="col-9 offset-3">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-center">Chatbot</h3>
                            <p><strong>Welcome</strong></p>
                        </div>
                        <div class="card-body">
                            <div>
                                <div id="chat-container" class="overflow-auto"></div>
                                <!-- Typing indicator -->
                                <div class="typing-indicator" id="typing-indicator"></div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <form id="chat-form" class="input-group">
                                <input type="text" id="message-input" class="form-control" placeholder="Type your message..." aria-label="Type your message..." aria-describedby="send-button">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary" id="send-button">Send</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Other content in the footer -->
    <section class="container {{ grid_size }}">
        <p><a href="http://getgrav.org">Grav</a> was <i class="fa fa-code"></i> with <i class="fa fa-heart-o pulse "></i> by <a href="https://trilby.media">Trilby Media</a>.</p>
    </section>
</section>

<script>
    //Popup container
    document.addEventListener('DOMContentLoaded', function() {
        const chatbotTriggerBtn = document.getElementById('chatbot-trigger-btn');
        const chatbotPopup = document.getElementById('chatbot-popup');

        chatbotTriggerBtn.addEventListener('click', function() {
            if (chatbotPopup.style.display === 'none') {
                chatbotPopup.style.display = 'block';
            } else {
                chatbotPopup.style.display = 'none';
            }
        });
    });


    document.addEventListener('DOMContentLoaded', function() {
        const chatContainer = document.getElementById('chat-container');
        const typingIndicator = document.getElementById('typing-indicator');
        const messageInput = document.getElementById('message-input');

        function addMessage(message, isUser = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', isUser ? 'user' : 'bot');
            messageElement.innerText = message;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (message === '') return;

            addMessage(`You: ${message}`, true);
            showTypingIndicator();
            setTimeout(sendMessageToChatbot, 1000, message);
            messageInput.value = '';
        });

        function sendMessageToChatbot(message) {
            // Replace this with your actual API request logic
            const api_url = '{{ config.plugins.chatbot.api_url }}';
            const query_param = '{{ config.plugins.chatbot.query_param }}';
            const query_output = '{{ config.plugins.chatbot.query_output }}';
            const latitude = '{{ config.plugins.chatbot.Latitude }}';
            const longitude = '{{ config.plugins.chatbot.Longitude }}';
            // &message=${encodeURIComponent(message)
            const apiUrl = `${api_url}?query_param=${query_param}&query_output=${query_output}&Latitude=${latitude}&Longitude=${longitude}}`;

            fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                })
                .then(response => response.json())
                .then(data => {
                    hideTypingIndicator();
                    const botMessage = data.message;
                    addMessage(`Bot: ${botMessage}`);
                })
                .catch(error => {
                    hideTypingIndicator();
                    addMessage('Bot: Sorry, an error occurred.');
                    console.error('Error:', error);
                });
        }
    });

</script>
{% endblock %}
